{% load static %}

<nav class="navbar">
    <div class="navbar-container container">
        <input type="checkbox" name="yourCheckboxName" id="yourCheckboxId">
        <h2 class="logo" id="logo">Hanwooplz</h2>
        <div class="hamburger-lines">
            <span class="line line1"></span>
            <span class="line line2"></span>
            <span class="line line3"></span>
        </div>
        <ul class="menu-items">
            <li><a href="{% url 'hanwooplz_app:portfolio_list' %}">포트폴리오</a></li>
            <li><a href="{% url 'hanwooplz_app:project_list' %}">팀원모집</a></li>
            <li><a href="{% url 'hanwooplz_app:question_list' %}">질의응답</a></li>

            {% if user.is_authenticated %}
            <li><a href="{% url 'hanwooplz_app:chat' 0 user.id %}">채팅</a></li>
            <li class="icon-item"><a href="{% url 'hanwooplz_app:myinfo' user.id %}"><i class="fas fa-user"></i></a>
            </li>
            <li class="icon-item">
                <a id="notificationButton" href="#"><i class="fas fa-bell"></i></a>
                <span id="notificationCount" class="notification-count"></span>
                <div class="notification-container" id="notificationContainer">
                    <div id="notificationMessage" class="notification-message">
                        <ul id="notificationList"></ul>
                    </div>
                </div>
            </li>

            <li class="icon-item"><a href="{% url 'hanwooplz_app:logout' %}"><i class="fas fa-sign-out-alt"></i></a>
            </li>
            {% else %}
            <li class="icon-item"><a href="{% url 'hanwooplz_app:login' %}"><i class="fas fa-sign-in-alt"></i></a></li>
            {% endif %}
        </ul>
    </div>
</nav>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const logo = document.getElementById("logo");

        logo.addEventListener("click", function () {
            window.location.href = "{% url 'hanwooplz_app:main' %}";
        });
    });
</script>

<script>
    document.addEventListener("DOMContentLoaded", async function () {
        const notificationButton = document.getElementById("notificationButton");
        const notificationContainer = document.getElementById("notificationContainer");
        const notificationMessage = document.getElementById("notificationMessage");
        const notificationCount = document.getElementById("notificationCount");
        let isNotificationVisible = true;
        let notifications = [];
    
        // 함수를 사용하여 알림 갯수 업데이트
        async function updateNotificationCount() {
            // CSRF 토큰 가져오기
            const csrftoken = getCookie('csrftoken');
            const response = await fetch('/get_notifications/', {
                method: 'GET',
                headers: {
                    'X-CSRFToken': csrftoken
                }
            });
            const data = await response.json();
            notifications = data.notifications.notifications_list;

            let unresponse_list = [];

            notifications.forEach(notification => {
                if (notification.accept_or_not === null) {
                    unresponse_list.push(notification);
                }
            })

            if (unresponse_list.length > 0) {
                notificationCount.textContent = unresponse_list.length;
                notificationCount.style.display = "block"; // 값이 있을 때 보이도록 설정
            } else {
                notificationCount.style.display = "none"; // 값이 없을 때 숨김
            }

        }
    
        // 페이지 로드 시 알림 갯수 업데이트
        updateNotificationCount();
    
        notificationButton.addEventListener("click", async function (e) {
            e.stopPropagation();
    
            
                notificationContainer.style.display = "block";
                notificationMessage.innerHTML = "";

                // 알림 리스트를 accept_or_not=null 우선 순위로 정렬
                notifications.sort((a, b) => {
                    if (a.accept_or_not === null && b.accept_or_not !== null) return -1;
                    if (a.accept_or_not !== null && b.accept_or_not === null) return 1;
                    return 0;
                });

                notifications.forEach(notification => {
                    const listItem = document.createElement("div"); // 각 알림 메시지를 감싸는 div
                    listItem.classList.add("notification-item");
    
                    const messageText = document.createElement("p");
                    if (notification.accept_or_not === null) {
                        messageText.textContent = `'${notification.title}' 게시글에서 ${notification.sender}로부터 참가요청이 왔습니다.\n${notification.created_at}`;
                        listItem.appendChild(messageText);
                        const actionButtons = document.createElement("div"); // 액션 버튼들을 감싸는 div
                        actionButtons.classList.add("action-buttons");

                        const acceptButton = document.createElement("button");
                        acceptButton.textContent = "수락";
                        acceptButton.addEventListener("click", async function () {
                            const result = await sendAcceptanceResult(notification.id, '수락');
                            if (result.success) {
                                notification.accept_or_not = true;
                                acceptButton.style.display = "none";
                                rejectButton.style.display = "none";
                                messageText.textContent = `'${notification.title}' 게시글에서 ${notification.sender}의 참가를 수락했습니다.\n${notification.created_at}`;
                            }
                        });
                        actionButtons.appendChild(acceptButton);
                        
                        const rejectButton = document.createElement("button");
                        rejectButton.textContent = "거절";
                        rejectButton.addEventListener("click", async function () {
                            const result = await sendAcceptanceResult(notification.id, '거절');
                            if (result.success) {
                                notification.accept_or_not = false;
                                messageText.textContent = `'${notification.title}' 게시글에서 ${notification.sender}의 참가를 거절했습니다.\n${notification.created_at}`;
                                acceptButton.style.display = "none";
                                rejectButton.style.display = "none";
                            }
                        });
                        actionButtons.appendChild(rejectButton);

                        listItem.appendChild(actionButtons);
                    } else if (notification.accept_or_not === true) {
                        messageText.textContent = `'${notification.title}' 게시글에서 ${notification.sender}의 참가를 수락했습니다.\n${notification.created_at}`;
                        listItem.appendChild(messageText);
                    } else if (notification.accept_or_not === false) {
                        messageText.textContent = `'${notification.title}' 게시글에서 ${notification.sender}의 참가를 거절했습니다.\n${notification.created_at}`;
                        listItem.appendChild(messageText);
                    }
    
                    
                    notificationMessage.appendChild(listItem);
                });
            
    

            isNotificationVisible = !isNotificationVisible;
        });
    
        // 결과 서버로 보내기
        async function sendAcceptanceResult(notificationId, result) {
            // 서버에 결과 보내는 로직 추가
            const csrftoken = getCookie('csrftoken');
            const response = await fetch('/accept_reject_notification/', {
                method: 'POST',
                body: JSON.stringify({ notificationId, result }),
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                }
            });
            const data = await response.json();
            if (data.success) {
                console.log('결과가 성공적으로 서버로 전송되었습니다.');
            } else {
                console.error('결과 서버로 전송 중 오류가 발생했습니다.');
            }
        }
    
        // CSRF 토큰을 가져오는 함수
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // 이름으로 시작하는 쿠키가 있는지 확인
                    if (cookie.substring(0, name.length + 1) === name + '=') {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

    });
    
</script>